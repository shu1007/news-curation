<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TLDR;</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 min-h-screen text-gray-100">
  <header class="border-b border-gray-800">
    <div class="max-w-4xl mx-auto px-4 py-6 flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold tracking-tight text-white">TLDR;</h1>
        <p class="mt-1 text-sm text-gray-500">{{ updated_at }} / <span id="visible-count">{{ total_count }}</span> / {{ total_count }} articles</p>
      </div>
      <button onclick="toggleBookmarkView()" id="bookmark-filter-btn"
        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium bg-gray-800 text-gray-400 hover:bg-gray-700 hover:text-gray-200 transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
        <span id="bookmark-count">0</span>
      </button>
    </div>
  </header>

  {% if articles %}
  <nav id="filter-nav" class="bg-gray-900/80 backdrop-blur border-b border-gray-800 sticky top-0 z-10">
    <div class="max-w-4xl mx-auto px-4 py-2 space-y-1">
      <div>
        <button onclick="togglePanel('feed-panel')" class="inline-flex items-center gap-1 text-xs font-semibold text-gray-400 hover:text-gray-200 py-1">
          <span id="feed-arrow" class="transition-transform">&#9654;</span> Source:
          <span id="feed-active-label" class="text-cyan-400 font-bold">All</span>
        </button>
        <div id="feed-panel" class="hidden mt-1 pb-1">
          <button onclick="filterByFeed('')" data-feed-btn=""
            class="filter-feed-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-cyan-500 text-gray-950 cursor-pointer mr-1 mb-1">
            All
          </button>
          {% for name in feed_names %}
          <button onclick="filterByFeed('{{ name }}')" data-feed-btn="{{ name }}"
            class="filter-feed-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-300 hover:bg-gray-700 cursor-pointer mr-1 mb-1">
            {{ name }}
          </button>
          {% endfor %}
        </div>
      </div>
      <div>
        <button onclick="togglePanel('label-panel')" class="inline-flex items-center gap-1 text-xs font-semibold text-gray-400 hover:text-gray-200 py-1">
          <span id="label-arrow" class="transition-transform">&#9654;</span> Label:
          <span id="label-active-label" class="text-gray-200 font-bold">All</span>
        </button>
        <div id="label-panel" class="hidden mt-1 pb-1">
          <button onclick="filterByLabel('')" data-label-btn=""
            class="filter-label-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-900 cursor-pointer mr-1 mb-1">
            All
          </button>
          {% for label in all_labels[:25] %}
          <button onclick="filterByLabel('{{ label }}')" data-label-btn="{{ label }}"
            class="filter-label-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 hover:bg-gray-700 cursor-pointer mr-1 mb-1">
            {{ label }}
          </button>
          {% endfor %}
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="space-y-4" id="articles">
      {% for article in articles %}
      <article class="article-card bg-gray-900 rounded-lg border border-gray-800 p-5 hover:border-gray-700 transition-colors"
        data-feed="{{ article.feed_name }}"
        data-labels="{{ article.labels | join(',') if article.labels else '' }}"
        data-url="{{ article.url }}"
        data-title="{{ article.title_ja if (article.is_english and article.title_ja) else article.title }}"
        data-image="{{ article.image_url or '' }}">
        <div class="flex items-center justify-between gap-2 mb-1">
          <div class="flex items-center gap-2 flex-wrap">
            <span onclick="filterByFeed('{{ article.feed_name }}')"
              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-cyan-900/50 text-cyan-400 whitespace-nowrap cursor-pointer hover:bg-cyan-900/80">
              {{ article.feed_name }}
            </span>
            {% if article.is_english %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-900/50 text-emerald-400">
              EN→JA
            </span>
            {% endif %}
            <time class="text-xs text-gray-500 whitespace-nowrap" datetime="{{ article.published }}">
              {{ article.published[:10] }}
            </time>
          </div>
          <button onclick="toggleBookmark(this)" data-url="{{ article.url }}"
            class="bookmark-btn flex-shrink-0 p-1 rounded text-gray-600 hover:text-amber-400 transition-colors"
            title="Bookmark">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          </button>
        </div>
        <h2 class="text-base font-semibold text-gray-100">
          <a href="{{ article.url }}" target="_blank" rel="noopener noreferrer" class="hover:text-cyan-400 transition-colors">
            {% if article.is_english and article.title_ja %}
              {{ article.title_ja }}
            {% else %}
              {{ article.title }}
            {% endif %}
          </a>
        </h2>
        {% if article.is_english and article.title_ja %}
        <p class="text-xs text-gray-500 mt-0.5">{{ article.title }}</p>
        {% endif %}
        {% if article.image_url %}
        <div class="mt-3 -mx-5 overflow-hidden">
          <img src="{{ article.image_url }}" alt="" class="w-full max-h-80 object-contain bg-gray-800" loading="lazy"
            onerror="this.parentElement.style.display='none'">
        </div>
        {% endif %}
        {% if article.summary %}
        <p class="mt-2 text-sm text-gray-400 leading-relaxed">{{ article.summary }}</p>
        {% endif %}
        {% if article.labels %}
        <div class="mt-2 flex flex-wrap gap-1">
          {% for label in article.labels %}
          <span onclick="filterByLabel('{{ label }}')"
            class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-gray-500 cursor-pointer hover:bg-gray-700 hover:text-gray-300">
            {{ label }}
          </span>
          {% endfor %}
        </div>
        {% endif %}
      </article>
      {% endfor %}
    </div>

    <div id="bookmark-view" class="hidden space-y-4"></div>
  </main>
  {% else %}
  <main class="max-w-4xl mx-auto px-4 py-8">
    <div class="text-center py-12">
      <p class="text-gray-500">記事がありません。</p>
    </div>
  </main>
  {% endif %}

  <footer class="max-w-4xl mx-auto px-4 py-6 text-center text-xs text-gray-600">
    Powered by Ollama + feedparser
  </footer>

  <script>
    let activeFeed = '';
    let activeLabel = '';
    let showingBookmarks = false;

    const BOOKMARK_KEY = 'tldr_bookmarks';

    function getBookmarks() {
      try { return JSON.parse(localStorage.getItem(BOOKMARK_KEY)) || []; }
      catch { return []; }
    }

    function saveBookmarks(items) {
      localStorage.setItem(BOOKMARK_KEY, JSON.stringify(items));
    }

    function isBookmarked(url) {
      return getBookmarks().some(b => b.url === url);
    }

    function toggleBookmark(btn) {
      const url = btn.dataset.url;
      let bookmarks = getBookmarks();
      const idx = bookmarks.findIndex(b => b.url === url);
      if (idx === -1) {
        const card = btn.closest('.article-card');
        bookmarks.push({
          url: url,
          title: card.dataset.title,
          feed_name: card.dataset.feed,
          image_url: card.dataset.image
        });
      } else {
        bookmarks.splice(idx, 1);
      }
      saveBookmarks(bookmarks);
      renderBookmarkStates();
    }

    function removeBookmark(url) {
      let bookmarks = getBookmarks();
      bookmarks = bookmarks.filter(b => b.url !== url);
      saveBookmarks(bookmarks);
      renderBookmarkStates();
      renderBookmarkView();
    }

    function toggleBookmarkView() {
      showingBookmarks = !showingBookmarks;
      const articles = document.getElementById('articles');
      const bookmarkView = document.getElementById('bookmark-view');
      const filterNav = document.getElementById('filter-nav');
      if (showingBookmarks) {
        articles.classList.add('hidden');
        bookmarkView.classList.remove('hidden');
        if (filterNav) filterNav.classList.add('hidden');
        renderBookmarkView();
      } else {
        articles.classList.remove('hidden');
        bookmarkView.classList.add('hidden');
        if (filterNav) filterNav.classList.remove('hidden');
      }
      renderBookmarkStates();
    }

    function renderBookmarkView() {
      const container = document.getElementById('bookmark-view');
      const bookmarks = getBookmarks();
      if (bookmarks.length === 0) {
        container.innerHTML = '<div class="text-center py-12"><p class="text-gray-500">No bookmarks yet.</p></div>';
        return;
      }
      container.innerHTML = bookmarks.map(b => {
        const imgHtml = b.image_url
          ? `<div class="mt-3 -mx-5 overflow-hidden"><img src="${escapeHtml(b.image_url)}" alt="" class="w-full max-h-80 object-contain bg-gray-800" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`
          : '';
        return `<div class="bg-gray-900 rounded-lg border border-gray-800 p-5">
          <div class="flex items-center justify-between gap-2 mb-1">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-cyan-900/50 text-cyan-400">${escapeHtml(b.feed_name)}</span>
            <button onclick="removeBookmark('${escapeHtml(b.url)}')"
              class="flex-shrink-0 p-1 rounded text-amber-400 hover:text-red-400 transition-colors" title="Remove">
              <svg class="w-4 h-4" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
            </button>
          </div>
          <h2 class="text-base font-semibold text-gray-100">
            <a href="${escapeHtml(b.url)}" target="_blank" rel="noopener noreferrer" class="hover:text-cyan-400 transition-colors">${escapeHtml(b.title)}</a>
          </h2>
          ${imgHtml}
        </div>`;
      }).join('');
    }

    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    function renderBookmarkStates() {
      const bookmarks = getBookmarks();
      document.querySelectorAll('.bookmark-btn').forEach(btn => {
        const marked = bookmarks.some(b => b.url === btn.dataset.url);
        btn.querySelector('svg').setAttribute('fill', marked ? 'currentColor' : 'none');
        btn.classList.toggle('text-amber-400', marked);
        btn.classList.toggle('text-gray-600', !marked);
      });
      document.getElementById('bookmark-count').textContent = bookmarks.length;
      const filterBtn = document.getElementById('bookmark-filter-btn');
      if (showingBookmarks) {
        filterBtn.classList.remove('bg-gray-800', 'text-gray-400');
        filterBtn.classList.add('bg-amber-500/20', 'text-amber-400');
      } else {
        filterBtn.classList.remove('bg-amber-500/20', 'text-amber-400');
        filterBtn.classList.add('bg-gray-800', 'text-gray-400');
      }
    }

    function togglePanel(id) {
      const panel = document.getElementById(id);
      const isHidden = panel.classList.contains('hidden');
      panel.classList.toggle('hidden');
      const arrowId = id === 'feed-panel' ? 'feed-arrow' : 'label-arrow';
      document.getElementById(arrowId).style.transform = isHidden ? 'rotate(90deg)' : '';
    }

    function filterByFeed(feed) {
      activeFeed = feed;
      activeLabel = '';
      applyFilter();
    }

    function filterByLabel(label) {
      activeLabel = label;
      activeFeed = '';
      applyFilter();
    }

    function applyFilter() {
      const cards = document.querySelectorAll('.article-card');
      let count = 0;
      cards.forEach(card => {
        const cardFeed = card.dataset.feed;
        const cardLabels = card.dataset.labels ? card.dataset.labels.split(',') : [];
        const matchFeed = !activeFeed || cardFeed === activeFeed;
        const matchLabel = !activeLabel || cardLabels.includes(activeLabel);
        const visible = matchFeed && matchLabel;
        card.style.display = visible ? '' : 'none';
        if (visible) count++;
      });
      document.getElementById('visible-count').textContent = count;
      document.getElementById('feed-active-label').textContent = activeFeed || 'All';
      document.getElementById('label-active-label').textContent = activeLabel || 'All';
      updateButtons();
    }

    function updateButtons() {
      document.querySelectorAll('.filter-feed-btn').forEach(btn => {
        const val = btn.dataset.feedBtn;
        const isActive = val === activeFeed;
        btn.className = 'filter-feed-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium cursor-pointer mr-1 mb-1 '
          + (isActive ? 'bg-cyan-500 text-gray-950' : 'bg-gray-800 text-gray-300 hover:bg-gray-700');
      });
      document.querySelectorAll('.filter-label-btn').forEach(btn => {
        const val = btn.dataset.labelBtn;
        const isActive = val === activeLabel;
        btn.className = 'filter-label-btn inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium cursor-pointer mr-1 mb-1 '
          + (isActive ? 'bg-gray-200 text-gray-900' : 'bg-gray-800 text-gray-400 hover:bg-gray-700');
      });
    }

    // Initialize
    renderBookmarkStates();
  </script>
</body>
</html>
